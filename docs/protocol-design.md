# Protocol design

## Frame structure

```
# Request frame

0    1  0x55                 Start of frame
1    1  0x04                 Function request
2    1  0x83                 Frame type
4    1  0xAA                 End of frame
```

```
# Response frame

0    1  0x55                 Start of frame
1    1  0x14                 Function response
2    1  0x2A                 Frame type
.    .  ...
.    .  ...                  16 bytes data
.    .  ...
19   1  0xAA                 End of frame
```

## Frame types

```
TIANPOWER_FRAME_TYPE_SOFTWARE_VERSION = 0x81;
TIANPOWER_FRAME_TYPE_HARDWARE_VERSION = 0x82;
TIANPOWER_FRAME_TYPE_STATUS = 0x83;
TIANPOWER_FRAME_TYPE_GENERAL_INFO = 0x84;
TIANPOWER_FRAME_TYPE_MOSFET_STATUS = 0x85;
TIANPOWER_FRAME_TYPE_GYRO = 0x86;
TIANPOWER_FRAME_TYPE_TEMPERATURES = 0x87;
TIANPOWER_FRAME_TYPE_CELL_VOLTAGES_1_8 = 0x88;
TIANPOWER_FRAME_TYPE_CELL_VOLTAGES_9_16 = 0x89;
TIANPOWER_FRAME_TYPE_CELL_VOLTAGES_17_24 = 0x8A;
TIANPOWER_FRAME_TYPE_LOCATION = 0x90;
TIANPOWER_FRAME_TYPE_OWNER = 0x94;
```


## Software version frame

```
Request:  0x55 0x04 0x81 0xaa
Response: 0x55 0x14 0x81 0x30 0x2e 0x31 0x2e 0x31 0x30 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa

Byte Len Payload      Description                      Unit  Precision
 0    1  0x55         Start of frame
 1    1  0x14         Frame type (Response)
 2    1  0x81         Address
 3    16 0x30 0x2e 0x31 0x2e 0x31 0x30 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00    "0.1.10"
 19   1  0xaa         End of frame
```

## Hardware version frame

```
Request:  0x55 0x04 0x82 0xaa
Response: 0x55 0x14 0x82 0x54 0x50 0x2d 0x4c 0x54 0x35 0x35 0x00 0x54 0x42 0x00 0x00 0x00 0x00 0x00 0x00 0xaa

Byte Len Payload      Description                      Unit  Precision
 0    1  0x55         Start of frame
 1    1  0x14         Frame type (Response)
 2    1  0x82         Address
 3    16 0x54 0x50 0x2d 0x4c 0x54 0x35 0x35 0x00 0x54 0x42 0x00 0x00 0x00 0x00 0x00 0x00    "TP-LT55" "TB"
 19   1  0xaa         End of frame
```

## Status frame

```
Request:  0x55 0x04 0x83 0xaa
Response: 0x55 0x14 0x83 0x00 0x3c 0x14 0x72 0x01 0x18 0x00 0xe6 0x00 0xf0 0x00 0x00 0x30 0x30 0x00 0x64 0xaa

Byte Len Payload      Description                      Unit  Precision
 0    1  0x55         Start of frame
 1    1  0x14         Frame type (Response)
 2    1  0x83         Address
 3    2  0x00 0x3c    State of charge (60%)              %   1.0    60%
 5    2  0x14 0x72    Total voltage                      V   0.1f   52.34V
 7    2  0x01 0x18    Average temperature               °C   0.1f   28.0°C
 9    2  0x00 0xe6    Ambient temperature               °C   0.1f   23.0°C
 11   2  0x00 0xf0    Mosfet temperature                °C   0.1f   24.0°C
 13   2  0x00 0x00    Current (signed)
 15   2  0x30 0x30    Unknown (signed)
 17   2  0x00 0x64    State of health                    %   1.0    100%
 19   1  0xaa         End of frame
```

## General info frame

```
Request:  0x55 0x04 0x84 0xaa
Response: 0x55 0x14 0x84 0x10 0x04 0x59 0xd8 0x36 0x48 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa

Byte Len Payload      Description                      Unit  Precision
 0    1  0x55         Start of frame
 1    1  0x14         Frame type (Response)
 2    1  0x84         Address
 3    1  0x10         Cell count                             1.0    16
 4    1  0x04         Temp sensors                           1.0    16
 5    2  0x59 0xd8    Nominal capaciy                   Ah   0.01f  230.00 Ah
 7    2  0x36 0x48    Capacity remaining                Ah   0.01f  138.96 Ah
 9    2  0x00 0x00    Cycle count                            1.0    0
 11   2  0x00 0x00    Voltage Status Bitmask
 13   2  0x00 0x00    Current Status Bitmask
 15   2  0x00 0x00    Temperature Status Bitmask
 17   2  0x00 0x00    Alarm Bitmask
 19   1  0xaa         End of frame
```

## Mosfet status frame

```
Request:  0x55 0x04 0x85 0xaa
Response:  0x55 0x14 0x85 0x08 0x23 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa

Byte Len Payload      Description                      Unit  Precision
 0    1  0x55         Start of frame
 1    1  0x14         Frame type (Response)
 2    1  0x85         Address
 3    2  0x08 0x23    Mosfet Status Bitmask (0b100000100011)
 5    2  0x00 0x00    Unknown Bitmask
 7    2  0x00 0x00    Unknown Bitmask
 9    2  0x00 0x00    High Alarm Bitmask
 11   2  0x00 0x00    Low Alarm Bitmask
 13   2  0x00 0x00    Balancing Bitmask
 15   2  0x00 0x00    Unused
 17   2  0x00 0x00    Unused
 19   1  0xaa         End of frame
```

## Temperatures frame

```
Request:  0x55 0x04 0x87 0xaa
Response:  0x55 0x14 0x87 0x00 0xe6 0x00 0xe6 0x00 0xe6 0x00 0xe6 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa

Byte Len Payload      Description                      Unit  Precision
 0    1  0x55         Start of frame
 1    1  0x14         Frame type (Response)
 2    1  0x87         Address
 3    2  0x00 0xe6    Temperature 1                    °C    0.1f  23.0°C
 5    2  0x00 0xe6    Temperature 2                    °C    0.1f  23.0°C
 7    2  0x00 0xe6    Temperature 3                    °C    0.1f  23.0°C
 9    2  0x00 0xe6    Temperature 4                    °C    0.1f  23.0°C
 11   2  0x00 0x00    Temperature 5
 13   2  0x00 0x00    Temperature 6
 15   2  0x00 0x00    Temperature 7
 17   2  0x00 0x00    Temperature 8
 19   1  0xaa         End of frame
```

## Cell voltages frame (3 frames / chunks)

```
Request:  0x55 0x04 0x88 0xaa 
Response: 0x55 0x14 0x88 0x0c 0xc1 0x0c 0xd5 0x0c 0xd2 0x0c 0xd5 0x0c 0xc8 0x0c 0xd4 0x0c 0xc8 0x0c 0xd2 0xaa

Byte Len Payload      Description                      Unit  Precision
 0    1  0x55         Start of frame
 1    1  0x14         Frame type (Response)
 2    1  0x87         Address
 3    2  0x96 0x0C    Cell voltage 1                   V     0.001f  3.265V
 5    2  0x97 0x0C    Cell voltage 2                   V     0.001f  3.285V
 7    2  0x98 0x0C    Cell voltage 3                   V     0.001f  3.282V
 9    2  0x98 0x0C    Cell voltage 4                   V     0.001f 
 11   2  0x96 0x0C    Cell voltage 5                   V     0.001f
 13   2  0x96 0x0C    Cell voltage 6                   V     0.001f
 15   2  0x98 0x0C    Cell voltage 7                   V     0.001f
 17   2  0x98 0x0C    Cell voltage 8                   V     0.001f
 19   1  0xaa         End of frame
```

```
Response: 0x55 0x14 0x89 0x0c 0xc8 0x0c 0xc8 0x0c 0xc7 0x0c 0xc7 0x0c 0xc1 0x0c 0xc3 0x0c 0xca 0x0c 0xc8 0xaa

Byte Len Payload      Description                      Unit  Precision
 0    1  0x55         Start of frame
 1    1  0x14         Frame type (Response)
 2    1  0x87         Address
 3    2  0x0c 0xc8    Cell voltage 9                   V     0.001f
 5    2  0x0c 0xc8    Cell voltage 10                  V     0.001f
 7    2  0x0c 0xc7    Cell voltage 11                  V     0.001f
 9    2  0x0c 0xc7    Cell voltage 12                  V     0.001f 
 11   2  0x0c 0xc1    Cell voltage 13                  V     0.001f
 13   2  0x0c 0xc3    Cell voltage 14                  V     0.001f
 15   2  0x0c 0xca    Cell voltage 15                  V     0.001f
 17   2  0x0c 0xc8    Cell voltage 16                  V     0.001f
 19   1  0xaa         End of frame
```

## Location frame

```
Request:  0x55 0x04 0x90 0xaa
Response: 0x55 0x14 0x90 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa
                           1    2    3    4    5    6    7    8    9   10   11   12   13   14   15   16
```

```
Response: 0x55 0x14 0x91 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa
                          17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32
```

32 chars "location setting"

## Owner frame

```
Request:  0x55 0x04 0x94 0xaa
Response: 0x55 0x14 0x94 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa
                           1    2    3    4    5    6    7    8    9   10   11   12   13   14   15   16
```

```
Response: 0x55 0x14 0x95 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xaa
                          17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32
```

32 chars "owner setting"
